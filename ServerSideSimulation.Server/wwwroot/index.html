<html>
<body>
    <script>
        const width = 800;
        const height = 800;
        const pixelSize = 4;

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        document.body.appendChild(canvas);

        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(width, height);
        const buffer = new Uint8Array(width * height * pixelSize);

        const socket = new WebSocket('ws://localhost:8080/ws');
        socket.binaryType = 'arraybuffer';

        socket.onmessage = function (event) {
            const data = decodeFrame(new Uint8Array(event.data));

            if (data.length === buffer.length) {
                buffer.set(data);
                imageData.data.set(buffer);
                ctx.putImageData(imageData, 0, 0);
            } else {
                console.warn("Mismatching buffer size. Skipping frame.");
                console.warn("Exptected: " + buffer.length + ", Actual: " + data.length);
            }
        };

        socket.onopen = function () {
            console.log('Connected to the server.');
        };

        socket.onerror = function (error) {
            console.error('WebSocket Error: ', error);
        };

        socket.onclose = function () {
            console.log('WebSocket connection closed.');
        };

        function decodeFrame(encodedFrame) {
            var outputBuffer = new Uint8Array(buffer.length);
            var headerLength = 6;
            var frameType = encodedFrame[1];

            var data = encodedFrame.slice(headerLength)
            if (data.length * pixelSize !== outputBuffer.length) {
                console.warn("Mismatching encoded frame size. Skipping frame.");
                console.warn("Exptected: " + buffer.length + ", Actual: " + data.length);
                return encodedFrame;
            }

            // decode indexed colors as gray scales
            for (let i = 0, iOut = 0; i < data.length; i++, iOut += pixelSize) {
                outputBuffer[iOut] = data[i];
                outputBuffer[iOut+1] = data[i];
                outputBuffer[iOut+2] = data[i];
                outputBuffer[iOut+3] = 0xFF;
            }

            return outputBuffer;
        }
    </script>
</body>
</html>